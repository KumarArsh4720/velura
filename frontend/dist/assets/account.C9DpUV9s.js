import"./modulepreload-polyfill.YP0FEG5d.js";const e="/api/auth";let t=null,n=null,i=[],a=[],o=null;async function c(){if(t)try{if(!(await s()))return;document.getElementById("userName").textContent=t.name||"User",document.getElementById("userEmail").textContent=t.email,t.profilePicture&&(document.getElementById("profilePicture").innerHTML=`<img src="${t.profilePicture}" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`),await Promise.all([l(),r(),d()])}catch(n){n.message.includes("401")||n.message.includes("Authentication failed")?(f("Session expired. Please login again.","error"),setTimeout(()=>{!async function(){try{await fetch(`${e}/devices/signout-current`,{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("velura_token")}`}})}catch(n){}finally{localStorage.removeItem("velura_token"),localStorage.removeItem("velura_user"),localStorage.removeItem("velura_remember"),window.location.href="/auth"}}()},1500)):f("Error loading account data","error")}}async function s(){try{const t=localStorage.getItem("velura_token");if(!t)throw new Error("No token found");if(401===(await fetch(`${e}/user-info`,{headers:{Authorization:`Bearer ${t}`}})).status)throw new Error("Token invalid");return!0}catch(t){return localStorage.removeItem("velura_token"),localStorage.removeItem("velura_user"),window.location.href="/auth",!1}}async function l(){try{const t=await fetch(`${e}/subscription`,{headers:{Authorization:`Bearer ${localStorage.getItem("velura_token")}`}});if(t.ok){const e=await t.json();n=e.subscription,e.profiles&&(i=e.profiles),u(),m()}else n={plan:"free",status:"active",startDate:new Date,nextBillingDate:null,paymentMethod:null},u(),m()}catch(t){n={plan:"free",status:"active",startDate:new Date,nextBillingDate:null,paymentMethod:null},u(),m()}}async function r(){try{const n=await fetch(`${e}/profiles`,{headers:{Authorization:`Bearer ${localStorage.getItem("velura_token")}`}});if(n.ok){const e=await n.json();i=e.profiles}else i=[{name:t.name,avatar:"ðŸ‘¤",ageRating:"All Maturity Levels",locked:!1,isMain:!0}];v(),u()}catch(n){i=[{name:t.name,avatar:"ðŸ‘¤",ageRating:"All Maturity Levels",locked:!1,isMain:!0}],v(),u()}}async function d(){try{const t=await fetch(`${e}/devices`,{headers:{Authorization:`Bearer ${localStorage.getItem("velura_token")}`}});if(t.ok){const e=await t.json();a=e.devices;const i=a.find(e=>e.current);i&&(o=i.deviceId),g(),u(),e.deviceCount>=e.deviceLimit&&function(e){const t=document.getElementById("message");if(!t)return;t.innerHTML=`\n        <div style="display: flex; align-items: center; justify-content: space-between;">\n            <div>\n                <i class="bi bi-exclamation-triangle"></i>\n                Device limit reached (${e} device${e>1?"s":""} maximum)\n            </div>\n            ${n&&"free"===n.plan?'\n                <a href="javascript:void(0)" onclick="showSection(\'membership\')" \n                   style="color: #3b82f6; text-decoration: none; font-weight: 500;">\n                    Upgrade to add more devices\n                </a>\n            ':""}\n        </div>\n    `,t.className="message warning",t.style.display="block",setTimeout(()=>{t.style.display="none",t.innerHTML="",t.className="message"},1e4)}(e.deviceLimit)}else a=[{name:"Computer",type:"computer",lastActive:"Just now",current:!0,location:"Current location"}],g(),u()}catch(t){a=[{name:"Computer",type:"computer",lastActive:"Just now",current:!0,location:"Current location"}],g(),u()}}function u(){if(!n)return;const e={free:{name:"Free Tier",price:"$0.00",quality:"HD (720p)",profiles:"1",devices:"1",badge:"Free"},basic:{name:"Basic",price:"$2.99",quality:"HD (720p)",profiles:"1",devices:"1",badge:"Basic"},standard:{name:"Standard",price:"$4.99",quality:"Full HD (1080p)",profiles:"3",devices:"2",badge:"Standard"},premium:{name:"Premium",price:"$9.99",quality:"4K Ultra HD",profiles:"5",devices:"4",badge:"Premium"}},t=e[n.plan]||e.free,o=n.nextBillingDate?new Date(n.nextBillingDate).toLocaleDateString():"No upcoming billing";if(document.getElementById("overviewPlan").textContent=t.name,document.getElementById("overviewCost").textContent=t.price,document.getElementById("overviewBilling").textContent=o,document.getElementById("overviewProfiles").textContent=`${i.length}/${t.profiles}`,document.getElementById("overviewDevices").textContent=`${a.length}/${t.devices}`,document.getElementById("overviewPlanBadge").textContent=t.badge,a.length>=parseInt(t.devices)){const e=document.querySelector("#overviewSection .info-card");if(e&&!e.querySelector(".device-limit-warning")){const n=`\n                <div class="device-limit-warning" style="\n                    background: rgba(239, 68, 68, 0.1);\n                    border: 1px solid rgba(239, 68, 68, 0.3);\n                    border-radius: 8px;\n                    padding: 12px;\n                    margin-top: 20px;\n                    display: flex;\n                    align-items: center;\n                    gap: 10px;\n                    color: #ef4444;\n                ">\n                    <i class="bi bi-exclamation-triangle"></i>\n                    <div>\n                        <div style="font-weight: 600;">Device limit reached</div>\n                        <div style="font-size: 0.9rem; opacity: 0.8;">\n                            You're using all ${t.devices} device${t.devices>1?"s":""} allowed on your plan\n                        </div>\n                    </div>\n                </div>\n            `;e.insertAdjacentHTML("beforeend",n)}}}function m(){if(!n)return;const e={free:{name:"Free Tier",price:"$0.00",quality:"HD (720p)",profiles:"1",devices:"1",badge:"Free"},basic:{name:"Basic",price:"$2.99",quality:"HD (720p)",profiles:"1",devices:"1",badge:"Basic"},standard:{name:"Standard",price:"$4.99",quality:"Full HD (1080p)",profiles:"3",devices:"2",badge:"Standard"},premium:{name:"Premium",price:"$9.99",quality:"4K Ultra HD",profiles:"5",devices:"4",badge:"Premium"}},t=e[n.plan]||e.free,a=n.nextBillingDate?new Date(n.nextBillingDate).toLocaleDateString():"No upcoming billing",o=document.getElementById("membershipPlanName"),c=document.getElementById("membershipPrice"),s=document.getElementById("membershipQuality"),l=document.getElementById("membershipProfiles"),r=document.getElementById("membershipDevices"),d=document.getElementById("membershipPlanBadge"),u=document.getElementById("nextPaymentDate"),m=document.getElementById("paymentMethod");o&&(o.textContent=t.name),c&&(c.textContent=`${t.price}/month`),s&&(s.textContent=t.quality),l&&(l.textContent=t.profiles),r&&(r.textContent=t.devices),d&&(d.textContent=t.badge),u&&(u.textContent=a),m&&(m.textContent=n.paymentMethod?`â€¢â€¢â€¢â€¢ ${n.paymentMethod}`:"No payment method");const v=document.getElementById("cancelSubscriptionBtn"),g=document.getElementById("cancelSubscriptionSection");v&&g&&("free"!==n.plan?g.style.display="block":g.style.display="none");const p=document.getElementById("addProfileBtn");if(p){const e=parseInt(t.profiles);i.length>=e?p.style.display="none":p.style.display="flex"}}function v(){const e=document.getElementById("profilesGrid");e&&(e.innerHTML=i.map(e=>{const t=e._id||e.name||e.tempId,n=e.name||"Unnamed Profile",i=e.locked||!1;return`\n      <div class="profile-card ${i?"locked":""}">\n        <div class="profile-avatar">${e.avatar||"ðŸ‘¤"}</div>\n        <div class="profile-card-name">${n}</div>\n        <div class="profile-card-age">${e.ageRating||"All Maturity Levels"}</div>\n        <div class="profile-actions">\n          <button class="btn btn-outline" onclick="manageProfile('${t}')">\n            <i class="bi bi-gear"></i>\n            Manage\n          </button>\n          ${i?`\n            <button class="btn btn-outline" onclick="unlockProfile('${t}')">\n              <i class="bi bi-unlock"></i>\n              Unlock\n            </button>\n          `:`\n            <button class="btn btn-outline" onclick="lockProfile('${t}')">\n              <i class="bi bi-lock"></i>\n              Lock\n            </button>\n          `}\n          ${e.isMain?"":`\n            <button class="btn btn-outline" onclick="deleteProfile('${t}')" style="color: #ef4444; border-color: #ef4444;">\n              <i class="bi bi-trash"></i>\n              Delete\n            </button>\n          `}\n        </div>\n      </div>\n    `}).join(""))}function g(){const e=document.getElementById("devicesList");if(!e)return;const t=n?"free"===n.plan||"basic"===n.plan?1:"standard"===n.plan?2:4:1,i=`\n        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 10px;">\n            <div style="color: rgba(226, 232, 240, 0.8); font-size: 0.9rem;">\n                ${a.length} of ${t} devices active\n            </div>\n            ${a.length>=t?'\n                <div style="color: #ef4444; font-size: 0.9rem; font-weight: 500;">\n                    <i class="bi bi-exclamation-triangle"></i>\n                    Device limit reached\n                </div>\n            ':""}\n        </div>\n    `,c=a.map(e=>{const t={computer:"laptop",mobile:"phone",tablet:"tablet",tv:"tv"}[e.deviceType||e.type]||"device-unknown";let n="Unknown";try{if(e.loginDate){const t=new Date(e.loginDate);n=isNaN(t.getTime())?"Unknown":t.toLocaleDateString()+" "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}}catch(d){n="Unknown"}let i="Unknown";try{if(e.lastActive){const t=new Date(e.lastActive),n=new Date,a=Math.floor((n-t)/6e4);i=a<1?"Just now":a<60?`${a} minutes ago`:a<1440?`${Math.floor(a/60)} hours ago`:`${Math.floor(a/1440)} days ago`}}catch(d){i="Unknown"}const a=e.deviceName||e.name||"Unknown Device",c=e.browser||"Unknown",s=e.os||"Unknown",l=e.location||"Unknown Location",r=e.current||e.deviceId===o;return`\n            <div class="device-item ${r?"current-device":""}">\n                <div class="device-status">\n                    <i class="bi bi-${t} device-icon"></i>\n                    ${r?'<span class="status-indicator active"></span>':""}\n                </div>\n                <div class="device-info">\n                    <div class="device-name">\n                        ${a} ${r?'<span class="current-badge">This Device</span>':""}\n                    </div>\n                    <div class="device-details">\n                        <div class="device-specs">${c} â€¢ ${s}</div>\n                        <div class="device-location">${l}</div>\n                        <div class="device-activity">\n                            <span class="last-active">Last active: ${i}</span>\n                            <span class="login-date">Logged in: ${n}</span>\n                        </div>\n                    </div>\n                </div>\n                ${r?'\n                    <div class="device-actions">\n                        <button class="btn btn-outline" onclick="logout()">\n                            <i class="bi bi-box-arrow-right"></i>\n                            Logout\n                        </button>\n                    </div>\n                ':`\n                    <div class="device-actions">\n                        <button class="btn btn-outline btn-danger" onclick="signOutDevice('${e.deviceId||e.id}')">\n                            <i class="bi bi-power"></i>\n                            Sign Out\n                        </button>\n                    </div>\n                `}\n            </div>\n        `}).join("");e.innerHTML=i+c}function p(){const e=document.querySelectorAll(".nav-item");document.querySelectorAll(".content-section"),e.forEach(e=>{e.addEventListener("click",function(){!function(e){const t=document.querySelectorAll(".nav-item"),n=document.querySelectorAll(".content-section");t.forEach(e=>e.classList.remove("active")),document.querySelector(`[data-section="${e}"]`).classList.add("active"),n.forEach(e=>e.classList.remove("active")),document.getElementById(e+"Section").classList.add("active")}(this.getAttribute("data-section"))})})}function f(e,t){const n=document.getElementById("message");n&&(n.textContent=e,n.className=`message ${t}`,n.style.display="block",setTimeout(()=>{n.className="message",n.textContent="",n.style.display="none"},5e3))}document.addEventListener("DOMContentLoaded",function(){(function(){const e=localStorage.getItem("velura_token"),n=localStorage.getItem("velura_user");return e&&n?(t=JSON.parse(n),t.isGoogleUser,!0):(window.location.href="/auth",!1)})()&&(c(),p(),function(){const t=document.getElementById("securityForm");t&&t.addEventListener("submit",async function(t){t.preventDefault();const n=document.getElementById("newPassword").value,i=document.getElementById("confirmPassword").value;if(n&&n!==i)f("Passwords do not match","error");else if(n&&n.length<6)f("Password must be at least 6 characters","error");else if(n){f("Updating password...","success");try{const t=await fetch(`${e}/change-password`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("velura_token")}`},body:JSON.stringify({currentPassword:document.getElementById("currentPassword").value,newPassword:n})}),i=await t.json();i.success?(f("Password updated successfully!","success"),document.getElementById("securityForm").reset()):f(i.message,"error")}catch(a){f("Error updating password: "+a.message,"error")}}else f("No changes made","error")})}(),setInterval(async()=>{localStorage.getItem("velura_token")&&await s()},3e4))});
