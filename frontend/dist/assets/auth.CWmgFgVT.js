import"./modulepreload-polyfill.YP0FEG5d.js";const e="/api/auth";let t="";function o(e){const t=document.getElementById(e+"Form"),o=document.querySelector(`.auth-tab[data-tab="${e}"]`);if(!t||!o)return;document.querySelectorAll(".auth-form").forEach(e=>e.classList.remove("active")),t.classList.add("active"),document.querySelectorAll(".auth-tab").forEach(e=>e.classList.remove("active")),o.classList.add("active");const n=document.querySelector(".auth-tabs");n&&(n.style.display="flex"),r()}function n(){o("login");const e=new URLSearchParams(window.location.search).get("email"),t=new URLSearchParams;t.set("mode","login"),e&&t.set("email",e),window.history.replaceState({},"",`?${t.toString()}`)}function a(){o("register");const e=new URLSearchParams(window.location.search).get("email"),t=new URLSearchParams;t.set("mode","register"),e&&t.set("email",e),window.history.replaceState({},"",`?${t.toString()}`)}function s(e,t){const o=document.getElementById("message");o&&(o.textContent=e,o.className=`message ${t}`)}function r(){const e=document.getElementById("message");e&&(e.className="message")}function i(e,t){localStorage.setItem("velura_token",e),localStorage.setItem("velura_user",JSON.stringify(t));const o=document.getElementById("rememberCheckbox")?.classList.contains("checked");o?localStorage.setItem("velura_remember","true"):localStorage.removeItem("velura_remember")}function c(){window.location.href="/browse"}function l(e){const t=document.getElementById("resetAlert");t.className="reset-alert error",t.textContent=e,t.style.display="block"}document.addEventListener("DOMContentLoaded",function(){!function(){const t=document.getElementById("loginForm");t?.addEventListener("submit",async function(t){t.preventDefault();const o=document.getElementById("loginEmail").value,n=document.getElementById("loginPassword").value;if(o&&n){s("Accessing your account...","success");try{const t=await fetch(`${e}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:o,password:n})}),a=await t.json();a.success?(s("Welcome back! Redirecting...","success"),i(a.token,a.user),setTimeout(()=>c(),1500)):s(a.message,"error")}catch(a){s("Network error. Please try again.","error")}}else s("Please fill in all fields","error")});const o=document.getElementById("registerForm");o?.addEventListener("submit",async function(t){t.preventDefault();const o=document.getElementById("registerName").value,n=document.getElementById("registerEmail").value,a=document.getElementById("registerPassword").value,r=document.getElementById("confirmPassword").value;if(o&&n&&a&&r)if(a===r)if(a.length<6)s("Password must be at least 6 characters","error");else{s("Creating your account...","success");try{const t=await fetch(`${e}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:o,email:n,password:a})}),r=await t.json();r.success?(s("Account created successfully! Welcome to Velura.","success"),i(r.token,r.user),setTimeout(()=>c(),2e3)):s(r.message,"error")}catch(l){s("Network error. Please try again.","error")}}else s("Passwords do not match","error");else s("Please fill in all fields","error")});const a=document.getElementById("forgotForm");a?.addEventListener("submit",async function(t){t.preventDefault();const o=document.getElementById("forgotEmail").value;if(o){s("Sending reset instructions...","success");try{const t=await fetch(`${e}/forgot-password`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:o})}),a=await t.json();a.success?(s("If you have an email account with us, a reset link has been sent!","success"),setTimeout(()=>n(),3e3)):s(a.message,"error")}catch(a){s("Network error. Please try again.","error")}}else s("Please enter your email address","error")})}(),document.querySelectorAll(".auth-tab").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-tab");"login"===t?n():"register"===t&&a()})}),(async()=>{await async function(){try{const e=await fetch("/api/auth/config");if(!e.ok)throw new Error("Failed to load config");const o=await e.json();t=o.googleClientId||""}catch(e){s("Configuration error. Please refresh the page.","error")}}(),function(){const t=new URLSearchParams(window.location.search),o=t.get("verifyToken"),d=t.get("resetToken"),u=t.get("mode");if(t.get("email"),o)return void async function(t){try{s("Verifying your email...","success");const o=await fetch(`${e}/verify-email`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:t})}),a=await o.json();if(a.success){s("üéâ Email verified successfully! You can now login.","success");const e=window.location.origin+window.location.pathname;window.history.replaceState({},document.title,e);const t=JSON.parse(localStorage.getItem("velura_user")||"{}");t&&t.id&&(t.emailVerified=!0,localStorage.setItem("velura_user",JSON.stringify(t))),setTimeout(()=>n(),2e3)}else s(a.message,"error")}catch(o){s("‚ùå Email verification failed. Please try again.","error")}}(o);if(d)return void function(t){const o=document.querySelector(".auth-container");o&&(o.style.display="none");const a=document.getElementById("resetPage");a.style.display="flex",a.setAttribute("aria-hidden","false");const s=document.getElementById("dedicatedResetForm"),r=document.getElementById("resetAlert");r.style.display="none",r.textContent="",s.onsubmit=async function(o){o.preventDefault();const n=document.getElementById("resetPassword").value.trim(),a=document.getElementById("resetPasswordConfirm").value.trim();if(!n||!a)return void l("Please fill in both fields");if(n.length<6)return void l("Password must be at least 6 characters");if(n!==a)return void l("Passwords do not match");const s=document.getElementById("resetSubmit");s.disabled=!0,s.textContent="Resetting...";try{const o=await fetch(`${e}/reset-password`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:t,password:n})}),a=await o.json();o.ok&&a.success?(!function(e){const t=document.getElementById("resetAlert");t.className="reset-alert success",t.textContent=e,t.style.display="block"}("Password reset successfully! Redirecting to sign in..."),setTimeout(()=>{window.location.href=window.location.origin+"/auth.html?mode=login"},1400)):l(a.message||"Failed to reset password")}catch(r){l("Network error. Please try again.")}finally{const e=document.getElementById("resetSubmit");e.disabled=!1,e.textContent="Reset Password"}},document.getElementById("backToAuth").onclick=function(e){e.preventDefault(),function(){const e=document.getElementById("resetPage");e&&(e.style.display="none",e.setAttribute("aria-hidden","true"));const t=document.querySelector(".auth-container");if(t){t.style.display="flex";const e=window.location.origin+window.location.pathname;window.history.replaceState({},document.title,e),n()}}()}}(d);if("login"===u)return void n();if("register"===u)return void a();if("forgot"===u)return void function(){document.querySelectorAll(".auth-form").forEach(e=>e.classList.remove("active"));const e=document.getElementById("forgotForm");if(e){e.classList.add("active");const t=document.querySelector(".auth-tabs");t&&(t.style.display="none")}r()}();const m=t.get("code"),g=t.get("error");(m||g)&&async function(){const t=new URLSearchParams(window.location.search),o=t.get("code"),n=t.get("error");if(n){s(`Google authentication failed: ${n}`,"error");const e=window.location.origin+window.location.pathname;return void window.history.replaceState({},document.title,e)}if(o){s("Completing Google authentication...","success");try{const t=await fetch(`${e}/google-auth`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:o})}),n=await t.json();n.success?(s("Google authentication successful!","success"),i(n.token,n.user),setTimeout(()=>c(),1500)):s(n.message||"Google authentication failed","error")}catch(a){s("Google authentication failed. Please try again.","error")}finally{const e=window.location.origin+window.location.pathname;window.history.replaceState({},document.title,e)}}}();if(m||g){const e=window.location.origin+window.location.pathname;window.history.replaceState({},document.title,e)}}();const o=new URLSearchParams(window.location.search),d=o.get("mode"),u=o.get("email");(function(){const e=localStorage.getItem("velura_token"),t=localStorage.getItem("velura_user");return!(!e||!t||(s("Welcome back! Redirecting...","success"),setTimeout(()=>c(),1e3),0))})()||("register"===d||u?a():n(),u&&function(){const e=new URLSearchParams(window.location.search).get("email");if(e){const t=document.getElementById("registerEmail");t&&(t.value=decodeURIComponent(e))}}())})()});
